#!/bin/sh

sudo pacman -S lsb-release --noconfirm --needed

release=$(lsb_release -i | awk -F: '{$1=""; print $2}' | tr -d '[:space:]')

# ====================================
# Install packages
# ====================================

read -p 'Install virtualbox additions? (y/N): ' choice

if [ "$choice" = "y" ]; then
    sudo pacman -S xf86-video-vmware virtualbox-guest-utils --noconfirm --needed
fi

# Fonts
sudo pacman -S noto-fonts noto-fonts-emoji ttf-font-awesome ttf-iosevka-nerd otf-font-awesome --noconfirm --needed

# Utils
sudo pacman -S unzip zsh wget curl make ccache libsecret xsel --noconfirm --needed

# TODO: Check if the gnome-keyring package is necesary on non gnome systems

if [ "$release" == "Artix" ]; then
  # In artix before the yadm bootstrap process starts we need to remove xorg-mkfontscale
  sudo pacman -Rcsu xorg-mkfontscale --noconfirm
elif [ "$release" == "Arch" ]; then
  echo "No changes required, continue"
else 
  echo "Warn: Please have in mind that by the time of this update this bootstrap was validated on Arch and Artix"
fi

# pulseaudio pulseaudio-alsa
sudo pacman -S redshift xorg xorg-xinit feh dunst pamixer picom gnome-keyring --noconfirm --needed

# Desktop environment bases, bspwm packages and utils
sudo pacman -S rofi ranger bspwm sxhkd --noconfirm --needed
sudo pacman -S xmonad xmobar alacritty trayer --noconfirm --needed

# Develop dependecies / packages
sudo pacman -S hub github-cli httpie --noconfirm --needed

# Editors and dependencies
sudo pacman -S neovim emacs-nox ripgrep fd ctags --noconfirm --needed

# AUR Helper
if pacman -Qs yay > /dev/null ; then
    echo "Yay is already installed, moving on..."
else
    rm -rf yay
    git clone https://aur.archlinux.org/yay.git
    cd yay
    makepkg -si --noconfirm
fi

# Import Keys to Install Spotify
gpg --keyserver pool.sks-keyservers.net --recv-keys 931FF8E79F0876134EDDBDCCA87FF9DF48BF1C90
gpg --keyserver pool.sks-keyservers.net --recv-keys 2EBF997C15BDA244B6EBF5D84773BD5E130D1D45

yay -S stern polybar spicetify-cli python-ueberzug spotify betterlockscreen google-chrome aic94xx-firmware wd719x-firmware --needed --removemake --nocleanmenu --nodiffmenu --noeditmenu --noconfirm

# ====================================
# Polybar font
# ====================================

mkdir ~/.local &> /dev/null
mkdir ~/.local/share &> /dev/null
mkdir ~/.local/share/fonts &> /dev/null
curl https://raw.githubusercontent.com/adi1090x/polybar-themes/master/polybar-8/fonts/icomoon-feather.ttf > icomoon-feather.ttf
mv icomoon-feather.ttf ~/.local/share/fonts/
fc-cache -vf ~/.local/share/fonts/

# ====================================
# Powerline arrow fix
# ====================================

wget https://github.com/powerline/powerline/raw/develop/font/PowerlineSymbols.otf
mv PowerlineSymbols.otf ~/.local/share/fonts/
fc-cache -vf ~/.local/share/fonts/

# Make pacman display colored output
sudo sed -i 's/#Color/Color/g' /etc/pacman.conf

# =========================================
# Install antigen and zsh-autosuggestions
# =========================================
if [ -d "$HOME/.antigen" ]; then
    echo "Antigen is already installed, moving on..."
else
    mkdir $HOME/.antigen
    curl -L git.io/antigen > $HOME/.antigen/antigen.zsh
fi

if [ -d "$HOME/.fnm" ]; then
    echo "Fast Node Manager is already installed, moving on..."
else
    curl -fsSL https://github.com/Schniz/fnm/raw/master/.ci/install.sh | bash -s -- --skip-shell
fi

if [ -d "$HOME/.pyenv" ]; then
    echo "PyEnv is already installed, moving on"
else
    git clone https://github.com/pyenv/pyenv.git ~/.pyenv
fi

if [ -f "$HOME/.local/bin/kubectl" ]; then
    echo "Kubectl is already installed, moving on"
else
    mkdir -p $HOME/.local/bin
    curl --output $HOME/.local/bin/kubectl -L "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x $HOME/.local/bin/kubectl
fi

if [ -d "/opt/vscode" ]; then
    echo "VSCode is already installed, moving on..."
else
    wget -t0 https://go.microsoft.com/fwlink/\?LinkID\=620884 -O code-stable.tar.gz 
    tar -xvf code-stable.tar.gz && mv VSCode-linux-x64 vscode && sudo rm -rf /opt/vscode && sudo mv vscode /opt && rm code-stable.tar.gz
    sudo ln -sf /opt/vscode/bin/code /usr/bin/code
    sh ~/.config/Code/User/extensions.sh
fi

if [ -d "$HOME/.emacs.d/bin" ]; then
    echo "Doom emacs is already installed, moving on..."
else
   git clone --depth 1 https://github.com/hlissner/doom-emacs $HOME/.emacs.d
fi

# Sublime 
# TODO: Check if subl command is installed
curl -O https://download.sublimetext.com/sublimehq-pub.gpg && sudo pacman-key --add sublimehq-pub.gpg && sudo pacman-key --lsign-key 8A8F901A && rm sublimehq-pub.gpg
echo -e "\n[sublime-text]\nServer = https://download.sublimetext.com/arch/stable/x86_64" | sudo tee -a /etc/pacman.conf

sudo pacman -Syu broot exa thefuck fzf lxappearance sublime-text bat --noconfirm --needed

echo "=============="
echo "==== DONE ===="
echo "=============="

echo "chsh -s /bin/zsh"
echo "~/.config/Code/User/extensions.sh"
echo "~/.emacs.d/bin/doom install"
echo "initialize node"
echo "initialize python"
echo "startx"
echo "feh --bg-fill ~/.config/desktop/gruvbox.png"

# Change to zsh
zsh
